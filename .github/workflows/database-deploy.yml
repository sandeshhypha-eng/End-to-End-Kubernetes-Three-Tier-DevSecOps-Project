name: Database - Deploy MongoDB

on:
  push:
    paths:
      - 'Kubernetes-Manifests-file/Database/**'
  workflow_dispatch:
    inputs:
      deploy_target:
        description: 'Optional target (defaults to all)'
        required: false
        default: ''

jobs:
  deploy-db:
    name: Deploy MongoDB manifests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-south-1

      - name: Install kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'v1.27.3'

      - name: Update kubeconfig for EKS
        run: |
          aws eks update-kubeconfig --name dev --region ap-south-1

      - name: Ensure namespace exists
        run: |
          kubectl get namespace three-tier >/dev/null 2>&1 || kubectl create namespace three-tier

      - name: Set kubectl context namespace
        run: |
          kubectl config set-context --current --namespace=three-tier

      - name: Apply all manifests in Database folder
        run: |
          set -euo pipefail
          BASE=Kubernetes-Manifests-file/Database
          echo "Repo contents:"; ls -la ${BASE} || true

          echo "Applying all manifests under ${BASE} (recursively)"
          # Apply every manifest under the Database directory. This will apply
          # Secrets, Service, Deployment, PVCs, etc., depending on what's present.
          # Use recursive apply so nested files are handled too.
          kubectl -n three-tier apply -R -f "${BASE}"

      - name: Wait for mongodb rollout
        run: |
          kubectl -n three-tier rollout status deployment/mongodb --timeout=3m || (
            echo "Deployment rollout failed or timed out; fetching events" &&
            kubectl -n three-tier get pods -l app=mongodb -o wide &&
            kubectl -n three-tier describe deployment mongodb &&
            kubectl -n three-tier get events --sort-by='.lastTimestamp' &&
            exit 1
          )

# Required secrets: AWS_ACCESS_KEY_ID, AWS_SECRET_ACCESS_KEY, AWS_REGION, EKS_CLUSTER_NAME
